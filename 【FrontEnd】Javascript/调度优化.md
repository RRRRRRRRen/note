# å¸§å›è°ƒï¼š `requestAnimationFrame`

> `requestAnimationFrame()` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª**å¼‚æ­¥ API**ï¼Œç”¨äºåœ¨**ä¸‹ä¸€ä¸ªé‡ç»˜å‘¨æœŸ**æ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œé€šå¸¸ç”¨äºå®ç°é«˜æ€§èƒ½åŠ¨ç”»ã€‚

## ä¸€ã€å·¥ä½œåŸç†

- æµè§ˆå™¨æ¯ç§’æœ€å¤šåˆ·æ–° 60 æ¬¡ï¼ˆå³ 60 fpsï¼Œâ‰ˆ16.67 ms ä¸€å¸§ï¼‰ã€‚
- `requestAnimationFrame(fn)` ä¼šå°† `fn` æ³¨å†Œåœ¨**ä¸‹ä¸€å¸§æ¸²æŸ“ä¹‹å‰**æ‰§è¡Œã€‚
- æµè§ˆå™¨ä¼šè‡ªåŠ¨**èŠ‚æµ**å’Œ**åŒæ­¥å¸§ç‡**ï¼Œåœ¨æ ‡ç­¾é¡µä¸æ´»è·ƒæ—¶è‡ªåŠ¨æš‚åœè°ƒç”¨ï¼ŒèŠ‚çœæ€§èƒ½ã€‚

## äºŒã€ä¼˜ç‚¹

| ä¼˜ç‚¹    | è¯´æ˜                                 |
| ----- | ---------------------------------- |
| âœ”ï¸ é«˜æ•ˆ | è‡ªåŠ¨ä¸æµè§ˆå™¨åˆ·æ–°èŠ‚å¥åŒæ­¥ï¼Œé¿å…æ‰å¸§æˆ–å†—ä½™æ›´æ–°             |
| âœ”ï¸ èŠ‚èƒ½ | é¡µé¢ä¸åœ¨å‰å°æ—¶è‡ªåŠ¨æš‚åœï¼Œé¿å…èµ„æºæµªè´¹                 |
| âœ”ï¸ å¹³æ»‘ | æä¾›æµç•…åŠ¨ç”»ä½“éªŒï¼Œé€‚åˆæ¸¸æˆã€æ‹–æ‹½ç­‰åœºæ™¯                |
| âœ”ï¸ ç®€æ´ | æ›¿ä»£ `setInterval/setTimeout` åšåŠ¨ç”»æ›´ç›´è§‚ |

## ä¸‰ã€åŸºæœ¬è¯­æ³•

```js
let animationId;

function animate() {
  // æ›´æ–°åŠ¨ç”»é€»è¾‘
  drawSomething();

  // ç»§ç»­ä¸‹ä¸€å¸§
  animationId = requestAnimationFrame(animate);
}

// å¯åŠ¨åŠ¨ç”»
animate();

// åœæ­¢åŠ¨ç”»
cancelAnimationFrame(animationId);
```

## å››ã€æ¡ˆä¾‹ä»£ç 

### 1. èŠ‚æµ resizeã€scroll äº‹ä»¶

```js
let ticking = false;
window.addEventListener('scroll', () => {
  if (!ticking) {
    requestAnimationFrame(() => {
      // handleScroll
      ticking = false;
    });
    ticking = true;
  }
});
```

### 2. Vue ä¸­ä½¿ç”¨

```js
import { onMounted, onBeforeUnmount } from 'vue';

let animationId;

onMounted(() => {
  function update() {
    // æ›´æ–°æ•°æ®æˆ– DOM
    animationId = requestAnimationFrame(update);
  }
  update();
});

onBeforeUnmount(() => {
  cancelAnimationFrame(animationId);
});
```

## äº”ã€å®é™…ç”¨é€”åœºæ™¯

| åœºæ™¯     | ç¤ºä¾‹                       |
| ------ | ------------------------ |
| âœ… åŠ¨ç”»   | ä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ã€é¢œè‰²å˜æ¢ç­‰           |
| âœ… æ‹–æ‹½   | é¼ æ ‡è·Ÿéšã€æ»‘å—ã€è™šæ‹Ÿæ»šåŠ¨             |
| âœ… å¯è§†åŒ–  | æ•°æ®å›¾è¡¨ã€ç²’å­åŠ¨ç”»                |
| âœ… æ¸¸æˆå¼€å‘ | æ¸¸æˆä¸»å¾ªç¯ã€è§’è‰²ç§»åŠ¨ã€ç¢°æ’æ£€æµ‹          |
| âœ… æ€§èƒ½èŠ‚æµ | æ›¿ä»£ `mousemove` é«˜é¢‘è§¦å‘ï¼Œå¹³æ»‘å¤„ç† |

## å…­ã€å¯¹æ¯” `setTimeout / setInterval`

|ç‰¹æ€§| `requestAnimationFrame` | `setTimeout / setInterval` |
|---|---|---|
|å¸§åŒæ­¥|âœ… ä¸æµè§ˆå™¨åˆ·æ–°åŒæ­¥|âŒ ä¸åŒæ­¥ï¼Œå¯èƒ½æ‰å¸§æˆ–é‡ç»˜é‡å¤|
|èŠ‚æµ|âœ… ä¸æ´»è·ƒæ—¶è‡ªåŠ¨æš‚åœ|âŒ ä¼šæŒç»­æ‰§è¡Œ|
|æ€§èƒ½|âœ… GPU å‹å¥½ã€å°‘å¸ƒå±€é‡æ’|âŒ CPU å‹åŠ›å¤§|
|ä½¿ç”¨åœºæ™¯|åŠ¨ç”»ã€æ¸²æŸ“ç›¸å…³|é€šç”¨å®šæ—¶ä»»åŠ¡|

## å…«ã€æ³¨æ„äº‹é¡¹

- æ¯å¸§æ‰§è¡Œé€»è¾‘ä¸è¦å¤ªé‡ï¼Œå¦åˆ™ä¼šé€ æˆå¡é¡¿ã€‚
- ä¸é€‚åˆç”¨äºéåŠ¨ç”»ç›¸å…³é€»è¾‘ï¼ˆç”¨ `setTimeout` æ›´åˆé€‚ï¼‰ã€‚
- åŠ¨ç”»ç²’åº¦ä¸è¦å¤ªå°ï¼Œé¿å…é¢‘ç¹è§¦å‘å¤§é‡ DOM æ“ä½œã€‚
- éœ€æ‰‹åŠ¨å–æ¶ˆï¼ˆç»„ä»¶é”€æ¯æ—¶å–æ¶ˆï¼Œå¦åˆ™ä¼šå†…å­˜æ³„æ¼ï¼‰ã€‚

# ç©ºé—²å›è°ƒï¼š `requestIdleCallback`

> `requestIdleCallback(callback)` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ªå¼‚æ­¥ APIï¼Œç”¨äºåœ¨**æµè§ˆå™¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶**æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œé€‚ç”¨äºæ‰§è¡Œ**éå…³é”®ã€ä½ä¼˜å…ˆçº§ä»»åŠ¡**ã€‚
>
> å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯è®©ä½ ã€Œ**è¶æµè§ˆå™¨æœ‰ç©ºæ—¶å¹²ç‚¹äº‹**ã€ã€‚

## ä¸€ã€å·¥ä½œåŸç†

æµè§ˆå™¨åœ¨æ‰§è¡Œå®Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·äº¤äº’ã€å¸ƒå±€ã€æ¸²æŸ“ç­‰ï¼‰ä¹‹åï¼Œå¦‚æœå½“å‰å¸§è¿˜æœ‰æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨ `requestIdleCallback` æ³¨å†Œçš„å‡½æ•°ã€‚

å›è°ƒå‡½æ•°ä¼šæ¥æ”¶ä¸€ä¸ª `IdleDeadline` å¯¹è±¡å‚æ•°ï¼Œç”¨äºåˆ¤æ–­å½“å‰ç©ºé—²æ—¶é—´æ˜¯å¦å……è¶³ã€‚

## äºŒã€è¯­æ³•

```js
const handle = requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && tasks.length > 0) {
    doNextTask();
  }
}, options);

// å–æ¶ˆ
cancelIdleCallback(handle);
```

**`IdleDeadline` å¯¹è±¡ç»“æ„**

| å±æ€§ / æ–¹æ³•           | å«ä¹‰                         |
| ----------------- | -------------------------- |
| `timeRemaining()` | è¿”å›å½“å‰å¸§å‰©ä½™çš„ç©ºé—²æ¯«ç§’æ•°              |
| `didTimeout`      | æ˜¯å¦å› ä¸ºè¶…æ—¶å¼ºåˆ¶æ‰§è¡Œå›è°ƒï¼ˆè§ timeout å‚æ•°ï¼‰ |

**`options` å‚æ•°å¯¹è±¡ç»“æ„**

| å±æ€§        | å«ä¹‰                                                                                |
| --------- | --------------------------------------------------------------------------------- |
| `timeout` | å¦‚æœæŒ‡å®šäº† timeoutï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ­£å€¼ï¼Œè€Œå›è°ƒåœ¨ timeout æ¯«ç§’è¿‡åè¿˜æ²¡æœ‰è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå›è°ƒä»»åŠ¡å°†æ”¾å…¥äº‹ä»¶å¾ªç¯ä¸­æ’é˜Ÿï¼Œå³ä½¿è¿™æ ·åšæœ‰å¯èƒ½å¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚ |

**è¿”å›å€¼**

ä¸€ä¸ª IDï¼Œå¯ä»¥æŠŠå®ƒä¼ å…¥ `Window.cancelIdleCallback(id)` æ–¹æ³•æ¥ç»“æŸå›è°ƒã€‚

## ä¸‰ã€ä½¿ç”¨åœºæ™¯

|åœºæ™¯|ç¤ºä¾‹|
|---|---|
|âœ… å¼‚æ­¥é¢„åŠ è½½|æ‡’åŠ è½½æ¨¡å—ã€ç»„ä»¶ã€å›¾ç‰‡ç­‰|
|âœ… ç¼“å­˜å¤„ç†|æœ¬åœ°ç¼“å­˜æ›´æ–°ã€é¢„å†™å…¥|
|âœ… éé˜»å¡ä»»åŠ¡|æ—¥å¿—ä¸Šä¼ ã€åŸ‹ç‚¹ã€æ€§èƒ½ç»Ÿè®¡|
|âœ… è™šæ‹Ÿ DOM diff åæ¸…ç†|æ¸…ç†æ— å…³èŠ‚ç‚¹ã€ç»´æŠ¤ç¼“å­˜æ± |
|âœ… UI ç©ºé—²ä¼˜åŒ–|æ‹–åŠ¨ç»“æŸåå¤„ç†å›å¼¹åŠ¨ç”»ã€ä¿®å¤å¸ƒå±€ç­‰|

## å››ã€å’Œ `requestAnimationFrame` çš„åŒºåˆ«

| å¯¹æ¯”é¡¹    | `requestAnimationFrame` | `requestIdleCallback` |
| ------ | ----------------------- | --------------------- |
| æ‰§è¡Œæ—¶æœº   | ä¸‹ä¸€å¸§åˆ·æ–°å‰                  | ä¸»çº¿ç¨‹ç©ºé—²æ—¶                |
| é€‚ç”¨ä»»åŠ¡   | åŠ¨ç”»ã€è§†è§‰ç›¸å…³æ›´æ–°               | åå°ã€éç´§æ€¥ä»»åŠ¡              |
| å¸§åŒæ­¥    | æ˜¯ï¼ˆ~60 fpsï¼‰              | å¦ï¼ˆå–å†³äºç³»ç»Ÿè´Ÿè½½ï¼‰            |
| æ˜¯å¦ä¿è¯æ‰§è¡Œ | æ˜¯ï¼ˆæ¯å¸§éƒ½è°ƒï¼‰                 | å¦ï¼ˆå¯èƒ½è·³è¿‡ï¼‰               |

## äº”ã€ç¤ºä¾‹ä»£ç 

### 1. ç©ºé—²é¢„åŠ è½½æ¨¡å—

```js
requestIdleCallback(async () => {
  const { default: heavyModule } = await import('./heavy-module.js')
  heavyModule.init()
})
```

### 2. å»¶è¿ŸåŠ è½½å›¾ç‰‡

```js
requestIdleCallback(() => {
  const img = new Image()
  img.src = 'https://example.com/slow-image.jpg'
})
```

## å…­ã€Polyfill

requestIdleCallback ` åœ¨ Safari ä¸­å°šæœªåŸç”Ÿæ”¯æŒï¼ˆæˆªè‡³ 2025 å¹´ä¸­ï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨ Polyfillï¼š

```js
window.requestIdleCallback = window.requestIdleCallback || function (cb) {
  return setTimeout(() => {
    const start = Date.now();
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};

window.cancelIdleCallback = window.cancelIdleCallback || clearTimeout;
```

# ç›‘å¬å…ƒç´ äº¤å‰ï¼š `IntersectionObserver`

> `IntersectionObserver` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äº**å¼‚æ­¥ç›‘å¬ç›®æ ‡å…ƒç´ ä¸ç¥–å…ˆå…ƒç´ æˆ–è§†å£ï¼ˆviewportï¼‰äº¤å‰çŠ¶æ€çš„å˜åŒ–**ã€‚

## ä¸€ã€æ ¸å¿ƒåŸç†

- é€šè¿‡è§‚å¯Ÿå…ƒç´ å’Œæ ¹å…ƒç´ ï¼ˆé»˜è®¤ä¸ºæµè§ˆå™¨è§†å£ï¼‰äº¤å‰çš„æƒ…å†µï¼Œè§¦å‘å›è°ƒã€‚
- é‡‡ç”¨å¼‚æ­¥å›è°ƒæœºåˆ¶ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚
- æµè§ˆå™¨å†…éƒ¨åšäº†é«˜åº¦ä¼˜åŒ–ï¼Œé¿å…äº†å¤§é‡æ»šåŠ¨ç›‘å¬å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚

## äºŒã€è¯­æ³•

```js
const observer = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      console.log('å…ƒç´ è¿›å…¥è§†å£');
      // å¯ä»¥å–æ¶ˆç›‘å¬
      observer.unobserve(entry.target);
    }
  });
}, {
  root: null,           // ç›‘å¬ç›¸å¯¹äºå“ªä¸ªå…ƒç´ ï¼Œnull è¡¨ç¤ºè§†å£
  rootMargin: '0px',    // è§¦å‘çš„åç§»èŒƒå›´ï¼Œæ”¯æŒç±»ä¼¼ CSS margin è¯­æ³•
  threshold: 0.1        // äº¤å‰æ¯”ä¾‹ï¼Œ0~1 ä¹‹é—´ï¼Œå¯ä»¥æ˜¯æ•°ç»„
});
```

## ä¸‰ã€å‚æ•°è¯´æ˜

| å‚æ•°           | è¯´æ˜                                  |
| ------------ | ----------------------------------- |
| `root`       | ä½œä¸ºåŸºå‡†çš„å®¹å™¨å…ƒç´ ï¼Œé»˜è®¤æ˜¯æµè§ˆå™¨è§†å£                  |
| `rootMargin` | ç±»ä¼¼ CSS margin çš„åç§»é‡ï¼Œå¯ç”¨äºæå‰æˆ–å»¶åè§¦å‘       |
| `threshold`  | äº¤å‰æ¯”ä¾‹ï¼Œ0 è¡¨ç¤ºå…ƒç´ ä¸€è¿›å…¥å°±è§¦å‘ï¼Œ1 è¡¨ç¤ºå®Œå…¨è¿›å…¥æ‰è§¦å‘ï¼Œå¯ä»¥æ˜¯æ•°ç»„ |

## å››ã€å…¸å‹ä½¿ç”¨åœºæ™¯

|åœºæ™¯|è¯´æ˜|
|---|---|
|**å›¾ç‰‡æ‡’åŠ è½½**|å›¾ç‰‡è¿›å…¥è§†å£æ—¶æ‰åŠ è½½çœŸå®èµ„æºï¼ŒèŠ‚çœæµé‡|
|**æ— é™æ»šåŠ¨åŠ è½½**|åˆ—è¡¨æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤šæ•°æ®|
|**å¹¿å‘Šæˆ–å†…å®¹æ›å…‰ç»Ÿè®¡**|ç»Ÿè®¡ç”¨æˆ·çœ‹åˆ°äº†å“ªäº›å†…å®¹|
|**åŠ¨ç”»è§¦å‘**|å…ƒç´ è¿›å…¥è§†å£æ—¶æ’­æ”¾åŠ¨ç”»|
|**åœæ­¢è§†é¢‘æ’­æ”¾**|å…ƒç´ ç¦»å¼€è§†å£æ—¶æš‚åœè§†é¢‘|

## äº”ã€ç¤ºä¾‹

### 1. å›¾ç‰‡æ‡’åŠ è½½

```js
const images = document.querySelectorAll('img[data-src]');

const lazyLoad = (entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      observer.unobserve(img);
    }
  });
};

const observer = new IntersectionObserver(lazyLoad, {
  rootMargin: '100px',
  threshold: 0.1
});

images.forEach(img => observer.observe(img));
```

### 2. å‚æ•°ç»„åˆå»ºè®®

|ä½¿ç”¨åœºæ™¯|rootMargin|threshold|
|---|---|---|
|å›¾ç‰‡æ‡’åŠ è½½| `'200px'` | `0` or `0.1` |
|æ»šåŠ¨åŠ è½½æ›´å¤š| `'0px 0px 300px 0px'` | `0` |
|æ›å…‰ç»Ÿè®¡| `0px` | `0.5` or `1` |
|åŠ¨ç”»è§¦å‘| `'50px'` | `0.3` |

## å…­ã€å…¼å®¹æ€§

 IE ä¸æ”¯æŒï¼Œéœ€ç”¨ polyfill

## ä¸ƒã€æ€§èƒ½ä¼˜åŠ¿

- ä»£æ›¿ä¼ ç»Ÿçš„æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œæ— éœ€è‡ªå·±å†™å¤æ‚çš„èŠ‚æµé˜²æŠ–ã€‚
- æµè§ˆå™¨åº•å±‚å®ç°é«˜æ•ˆè°ƒåº¦ï¼Œé¿å…é¢‘ç¹ DOM è®¿é—®ã€‚
- å›è°ƒå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡æ¸²æŸ“ã€‚

# ç›‘å¬å¤§å°å˜åŒ–ï¼š `ResizeObserver`

> `ResizeObserver` ç”¨äº**ç›‘å¬ä¸€ä¸ª DOM å…ƒç´ å°ºå¯¸çš„å˜åŒ–ï¼ˆå®½åº¦æˆ–é«˜åº¦ï¼‰**ï¼Œå½“å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«å¼‚æ­¥è°ƒç”¨ã€‚
>
> å®ƒä¸ä¼šç›‘å¬å…ƒç´ å†…å®¹å˜åŒ–ï¼Œåªå…³æ³¨ **padding / border / size** å¯¼è‡´çš„ **å¸ƒå±€å°ºå¯¸** å˜åŒ–ã€‚

## ä¸€ã€ä½¿ç”¨åœºæ™¯

|åœºæ™¯|è¯´æ˜|
|---|---|
|å“åº”å¼å¸ƒå±€ç›‘å¬|å…ƒç´ å¤§å°å˜åŒ–åè‡ªåŠ¨é‡æ–°æ’ç‰ˆæˆ–è®¡ç®—|
|ç»„ä»¶è‡ªé€‚åº”è°ƒæ•´|å›¾è¡¨å®¹å™¨ç¼©æ”¾ï¼Œé‡æ–°ç»˜åˆ¶|
|å®ç° container-queryï¼ˆå®¹å™¨æŸ¥è¯¢ï¼‰æ•ˆæœ||
|è™šæ‹Ÿæ»šåŠ¨åŒºåŸŸå°ºå¯¸æ›´æ–°||
|å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è‡ªåŠ¨æ¢è¡Œå¤„ç†||
|æ¸¸æˆ / Canvas è‡ªåŠ¨ç¼©æ”¾é€‚é…||

## äºŒã€ç¤ºä¾‹

### 1. æ™®é€šç¤ºä¾‹

```js
const box = document.querySelector('#box')

const resizeObserver = new ResizeObserver((entries) => {
  for (let entry of entries) {
    const { width, height } = entry.contentRect
    console.log(`å°ºå¯¸å˜åŒ–ï¼š${width}px x ${height}px`)
  }
})

resizeObserver.observe(box)
```

### 2. Vue 3 ç¤ºä¾‹

```vue
<template>
  <div ref="elRef" class="resize-box">
    å½“å‰å®½åº¦ï¼š{{ size.width }}ï¼Œé«˜åº¦ï¼š{{ size.height }}
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from 'vue'

const elRef = ref(null)
const size = ref({ width: 0, height: 0 })

let observer

onMounted(() => {
  observer = new ResizeObserver(([entry]) => {
    const { width, height } = entry.contentRect
    size.value = { width, height }
  })
  if (elRef.value) observer.observe(elRef.value)
})

onBeforeUnmount(() => {
  if (observer) observer.disconnect()
})
</script>

<style scoped>
.resize-box {
  resize: both;
  overflow: auto;
  border: 1px solid #ccc;
  padding: 10px;
  width: 200px;
  height: 150px;
}
</style>
```

### 3. é˜²æŠ–å»ºè®®

```js
let timer
const resizeObserver = new ResizeObserver(entries => {
  clearTimeout(timer)
  timer = setTimeout(() => {
    // é˜²æŠ–é€»è¾‘
    for (const entry of entries) {
      console.log(entry.contentRect.width)
    }
  }, 100)
})
```

## ä¸‰ã€contentRect è¯´æ˜

å›è°ƒé‡Œçš„ `entry.contentRect` åŒ…å«å¦‚ä¸‹å°ºå¯¸ä¿¡æ¯ï¼š

|å±æ€§|å«ä¹‰|
|---|---|
| `width` / `height` |å…ƒç´ å¯è§åŒºåŸŸå°ºå¯¸ï¼ˆä¸å«æ»šåŠ¨æ¡ï¼‰|
| `top` / `left` |ç›¸å¯¹äºå…ƒç´ æœ¬èº«çš„ä½ç½®ï¼ˆä¸€èˆ¬æ˜¯ 0ï¼‰|
| `x` / `y` |åŒä¸Šï¼ˆä¸ `top/left` ç­‰ä»·ï¼‰|

## å››ã€æ³¨æ„äº‹é¡¹

| æ³¨æ„ç‚¹                    | è¯´æ˜                 |
| ---------------------- | ------------------ |
| ğŸ” ä¼šè§¦å‘å¤šæ¬¡               | å…ƒç´ å˜åŒ–é¢‘ç¹æ—¶å›è°ƒå¤šæ¬¡ï¼Œå»ºè®®é˜²æŠ–   |
| ğŸ§± ç›‘å¬ display: none æ— æ•ˆ | å…ƒç´ éšè—æ—¶ä¸è§¦å‘           |
| ğŸ”‚ è‡ªèº«å˜åŠ¨è§¦å‘è‡ªèº«å›è°ƒ          | æ³¨æ„é¿å…æ­»å¾ªç¯ï¼Œæ¯”å¦‚ç›‘å¬ååˆä¿®æ”¹å®½é«˜ |
| ğŸ§¼ ä½¿ç”¨ `.disconnect()`  | ç»„ä»¶å¸è½½å‰æ–­å¼€ç›‘å¬ï¼Œé¿å…å†…å­˜æ³„æ¼   |

# ç›‘å¬èŠ‚ç‚¹å˜åŒ–ï¼š `MutationObserver`

> `MutationObserver` æ˜¯æµè§ˆå™¨æä¾›çš„**åŸç”Ÿ API**ï¼Œç”¨äº**ç›‘å¬ DOM çš„ç»“æ„å˜åŒ–æˆ–å±æ€§å˜åŒ–**ã€‚
>
> å®ƒå¯ä»¥åœ¨ä¸ä½¿ç”¨è½®è¯¢çš„æƒ…å†µä¸‹ï¼Œ**é«˜æ•ˆåœ°æ•æ‰åˆ°æŸä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€å±æ€§ã€æ–‡æœ¬å†…å®¹ç­‰å˜æ›´**ã€‚

## ä¸€ã€ç›‘å¬èŒƒå›´

ä½ å¯ä»¥ç›‘å¬ä»¥ä¸‹å‡ ç±» DOM å˜åŒ–ï¼š

|ç±»å‹|æè¿°|
|---|---|
| `childList` |å­å…ƒç´ æ–°å¢æˆ–åˆ é™¤|
| `attributes` |å±æ€§å˜åŒ–|
| `characterData` |æ–‡æœ¬èŠ‚ç‚¹å†…å®¹å˜åŒ–|
| `subtree` |æ˜¯å¦è§‚å¯Ÿæ‰€æœ‰åä»£èŠ‚ç‚¹|
| `attributeOldValue` |æ˜¯å¦è®°å½•å±æ€§æ—§å€¼|
| `characterDataOldValue` |æ˜¯å¦è®°å½•æ–‡æœ¬æ—§å€¼|

## äºŒã€åŸºæœ¬ç”¨æ³•ç¤ºä¾‹

### 1. åŸºæœ¬æ¡ˆä¾‹

```js
const target = document.getElementById('box')

const observer = new MutationObserver((mutationsList, observer) => {
  for (const mutation of mutationsList) {
    console.log('å‘ç”Ÿå˜åŒ–çš„ç±»å‹:', mutation.type)
    if (mutation.type === 'childList') {
      console.log('å­èŠ‚ç‚¹å˜åŒ–:', mutation.addedNodes, mutation.removedNodes)
    } else if (mutation.type === 'attributes') {
      console.log('å±æ€§å˜åŒ–:', mutation.attributeName)
    } else if (mutation.type === 'characterData') {
      console.log('æ–‡æœ¬å˜åŒ–:', mutation.target.data)
    }
  }
})

observer.observe(target, {
  childList: true,
  attributes: true,
  characterData: true,
  subtree: true,
})
```

### 2. Vue æ¡ˆä¾‹

```vue
<template>
  <div ref="targetEl">å†…å®¹</div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from 'vue'

const targetEl = ref(null)
let observer

onMounted(() => {
  observer = new MutationObserver((mutations) => {
    console.log('å˜åŒ–ï¼š', mutations)
  })

  observer.observe(targetEl.value, {
    childList: true,
    attributes: true,
    subtree: true
  })
})

onBeforeUnmount(() => {
  observer?.disconnect()
})
</script>
```

## ä¸‰ã€å‚æ•°è¯´æ˜

**åŸºæœ¬å‚æ•°**

- `new MutationObserver(callback)`
  - `callback`ï¼šå½“ç›‘å¬åˆ°å˜åŒ–æ—¶æ‰§è¡Œï¼Œå‚æ•°ä¸ºå˜åŒ–è®°å½•æ•°ç»„ï¼ˆ`MutationRecord[]`ï¼‰å’Œè§‚å¯Ÿå™¨å¯¹è±¡ã€‚
- `observer.observe(targetNode, options)`
  - `targetNode`ï¼šè¦ç›‘å¬çš„ç›®æ ‡èŠ‚ç‚¹
  - `options`ï¼šç›‘å¬é€‰é¡¹å¯¹è±¡

**å¸¸è§ `options` é…ç½®**

```js
{
  childList: true,              // ç›‘å¬å­èŠ‚ç‚¹æ·»åŠ /åˆ é™¤
  attributes: true,             // ç›‘å¬å±æ€§å˜åŒ–
  characterData: true,          // ç›‘å¬æ–‡æœ¬å˜åŒ–
  subtree: true,                // é€’å½’ç›‘å¬åä»£èŠ‚ç‚¹
  attributeOldValue: true,      // è®°å½•æ—§å±æ€§å€¼
  characterDataOldValue: true,  // è®°å½•æ—§æ–‡æœ¬å€¼
}
```

## å››ã€ä½¿ç”¨åœºæ™¯

|åœºæ™¯|è¯´æ˜|
|---|---|
|åŠ¨æ€æ¸²æŸ“æ£€æµ‹|ç›‘å¬ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ– iframe æ’å…¥çš„å†…å®¹|
|è‡ªåŠ¨è¡¨å•æ ¡éªŒ|ç”¨æˆ·è¾“å…¥æˆ–å±æ€§å˜åŒ–æ—¶è§¦å‘æ ¡éªŒé€»è¾‘|
|DOM å…ƒç´ å‡ºç°æˆ–æ¶ˆå¤±|æ¯”å¦‚å¼¹çª—ã€æç¤ºã€å¹¿å‘Šä½æ’å…¥|
|é¡µé¢æ•°æ®æ³¨å…¥ç›‘å¬|å¦‚ Chrome æ’ä»¶ä¿®æ”¹é¡µé¢æ—¶è§¦å‘|
|é˜²æ­¢ XSS åŠ¨æ€æ’å…¥ï¼ˆå®‰å…¨å±‚é¢ï¼‰||

## äº”ã€æ€§èƒ½å»ºè®®

| æ–¹æ³•              | è¯´æ˜                              |
| --------------- | ------------------------------- |
| `disconnect()`  | åœæ­¢ç›‘å¬                            |
| `takeRecords()` | ç«‹å³è·å–ä½†ä¸è§¦å‘å›è°ƒ                      |
| èŠ‚æµ/é˜²æŠ–å¤„ç†         | å˜åŒ–é¢‘ç¹æ—¶æ‰‹åŠ¨ debounce                |
| ç²¾å‡†ç›®æ ‡            | é¿å…ç›‘å¬æ•´ä¸ª `document.body`ï¼Œé€‰æ‹©å…·ä½“å®¹å™¨å³å¯ |

# å¾®ä»»åŠ¡è°ƒåº¦ï¼š `queueMicrotask`

## ä¸€ã€ç®€ä»‹

**è¯­æ³•**

```js
queueMicrotask(() => {
  console.log('è¿™æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡');
});
```

**ç‰¹ç‚¹**

- å®ƒç±»ä¼¼äº `Promise.then(...)`ã€‚
- æ‰§è¡Œé¡ºåºï¼š**åŒæ­¥ä»£ç  > å¾®ä»»åŠ¡ > å®ä»»åŠ¡ï¼ˆsetTimeoutã€setInterval ç­‰ï¼‰**

## äºŒã€æ‰§è¡Œé¡ºåº

```js
console.log('1');

queueMicrotask(() => {
  console.log('2');
});

Promise.resolve().then(() => {
  console.log('3');
});

setTimeout(() => {
  console.log('4');
}, 0);

console.log('5');
```

**è¾“å‡ºé¡ºåº**

```
1
5
2
3
4
```

**åˆ†æ**

1. åŒæ­¥ï¼š1, 5
2. å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šqueueMicrotask çš„ 2ï¼ŒPromise çš„ 3ï¼ˆé¡ºåºå¯èƒ½è°ƒæ¢ï¼‰
3. å®ä»»åŠ¡ï¼šsetTimeout çš„ 4

## ä¸‰ã€å’Œ `Promise.then()` çš„åŒºåˆ«

| ç‰¹ç‚¹     | `queueMicrotask`   | `Promise.then()`         |
| ------ | ------------------ | ------------------------ |
| æœ¬è´¨     | è°ƒåº¦å¾®ä»»åŠ¡              | ä¹Ÿæ˜¯å¾®ä»»åŠ¡ï¼ˆåŸºäºå¾®ä»»åŠ¡å®ç°ï¼‰           |
| å¯è¯»æ€§    | ç®€æ´æ¸…æ™°               | é€šå¸¸åµŒå¥—æˆ–é“¾å¼ï¼Œä¸é€‚åˆä¸´æ—¶è°ƒåº¦          |
| æ€§èƒ½     | å°‘ä¸€å±‚ promise åŒ…è£…ï¼Œæ›´è½»é‡ | åŒ…è£¹åœ¨ promise ä¸­ï¼Œç›¸å¯¹é‡        |
| é”™è¯¯å¤„ç†æœºåˆ¶ | æŠ›å‡ºçš„å¼‚å¸¸ä¼šç»ˆæ­¢æ•´ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—    | `Promise.catch()` å¯ä»¥æ•è·å¼‚å¸¸ |

**ç¤ºä¾‹**

```js
queueMicrotask(() => {
  throw new Error('oops'); // ä¼šä¸­æ–­åç»­å¾®ä»»åŠ¡é˜Ÿåˆ—
});

Promise.resolve().then(() => {
  throw new Error('oops'); // ä»å¯é€šè¿‡ .catch() å¤„ç†
}).catch(err => console.log('æ•è·åˆ°å¼‚å¸¸:', err));
```

## å››ã€ä½¿ç”¨åœºæ™¯

### 1. å¼‚æ­¥æ‰§è¡Œï¼Œä½†å°½é‡æ—©

æƒ³è®©æŸä¸ªé€»è¾‘å»¶è¿Ÿæ‰§è¡Œï¼ˆç­‰å½“å‰åŒæ­¥ä»»åŠ¡è·‘å®Œï¼‰ï¼Œä½†ä¸è¦ç­‰ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯ï¼ˆsetTimeout å¤ªæ…¢ï¼‰ã€‚

### 2. é¿å…é€’å½’æ ˆæº¢å‡º

```js
function process(data) {
  if (data.length === 0) return;
  queueMicrotask(() => process(data.slice(1)));
}
```
