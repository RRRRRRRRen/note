# 闭包与作用域

## 什么是闭包

官方说法：闭包就是指有权访问另一个函数作用域中的变量的函数。

## 闭包的作用

- 使我们在函数外部能够访问到函数内部的变量。通过使用闭包，可以通过在外部调用闭包函数，从而在外部访问到函数内部的变量，可以使用这种方法创建私有变量。
- 使已经结束运行的函数上下文中的变量对象继续留在内存中，因为闭包函数保留了这个变量对象的引用，所以这个变量对象不会被回收。

## 执行上下文的类型

**全局执行上下文**

任何不在函数内部的都是全局执行上下文，它首先会创建一个全局的 window 对象，斌且设置 this 的值等于这个全局变量，一个程序中只有一个全局执行上下文。

**函数执行上下文**

当一个函数被调用时，就会为该函数创建一个新的执行上下文，函数的上下文可以有任意个。

**eval 函数执行上下文**

执行 eval 函数的代码会有属于它自己的执行上下文。

## 执行上下文栈是什么

js 引擎使用执行上下文栈管理执行上下文。当 js 执行代码时，首先遇到全局代码，会创建一个全局执行上下文并且压入执行栈中，每当遇到一个函数调用，就会为该函数创建一个新的执行上下文并压入栈顶，引擎会执行位于执行上下文栈顶的函数，当函数执行完毕后，执行上下文从栈中弹出，继续执行下一个上下文。当所有的代码都执行完毕之后，从栈中弹出全局执行上下文。

## 执行上下文的三个阶段

**创建阶段**

this 绑定

- 在全局执行上下文中，this 指向全局对象 window
- 在函数执行上下文中，this 指向取决于函数如何被调用。

创建词法环境组件

- 词法环境是一种有标识符-变量映射的数据结构，标识符是指变量、函数名，变量是对实际对象或原始数据的引用。
- 词法环境有两个组件。环境记录器：庸才存储变量函数声明的实际位置。外部环境的引用：可以访问父级作用域。

创建变量环境组件

- 变量环境也是一个词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。

**执行阶段**

在这个阶段，执行变量的赋值、代码执行

**回收阶段**

执行上下文出栈等虚拟回收执行上下文。

## 什么是作用域

作用域可以视为一种规则，这个规则用来管理引擎如何在当前作用域以及嵌套的子作用域根据标识符名称进行变量查找。

简单来说，作用域就是变量的有效范围。在一定空间里可以对变量数据进行读写操作。

## 作用域的类型

**全局作用域**

- 直接写在 script 标签的 JS 代码，都在全局作用域。在全局作用域下声明的变量叫做全局变量（在块级外部定义的变量）。
- 全局变量在全局的任何位置下都可以使用；全局作用域中无法访问到局部作用域的中的变量。
- 全局作用域在页面打开的时候创建，在页面关闭时销毁。
- 所有 window 对象的属性拥有全局作用域
  - var 和 function 命令声明的全局变量和函数是 window 对象的属性和方法
  - let 命令、const 命令、class 命令声明的全局变量，不属于 window 对象的属性

**函数作用域（局部作用域）**

- 调用函数时会创建函数作用域，函数执行完毕以后，作用域销毁。每调用一次函数就会创建一个新的函数作用域，他们之间是相互独立的。
- 在函数作用域中可以访问全局变量，在函数的外面无法访问函数内的变量。
- 当在函数作用域操作一个变量时，它会先在自身作用域中寻找，如果有就直接使用，如果没有就向上一作用域中寻找，直到找到全局作用域，如果全局作用域中仍然没有找到，则会报错。

**块级作用域**

- ES6 之前 JavaScript 采用的是函数作用域+词法作用域，ES6 引入了块级作用域。
- 任何一对花括号{}中的语句集都属于一个块,**在块中使用 let 和 const 声明的变量**，外部是访问不到的，这种作用域的规则就叫块级作用域。
- 通过 var 声明的变量或者非严格模式下创建的函数声明没有块级作用域。

**词法作用域**

- 词法作用域是静态的作用域，无论函数在哪里被调用，也无论它如何被调用，它的词法作用域都只由**函数被声明时所处的位置**决定。
- 编译的词法分析阶段基本能够知道全部标识符在哪里以及是如何声明的，从而能够预测在执行过中如何对它们进行查找。
- 换句话说，词法作用域就是你在写代码的时候就已经决定了变量的作用域。

## 什么是作用域链

**概念**

作用域链本质上是一个指向变量对象的指针列表。变量对象是一个包含了执行环境中所有变量和函数的对象。作用域链的前端始终是当前执行上下文的变量对象。全局执行上下文的对象始终是作用域链的最后一个对象。

**作用**

作用域链的作用是保证对执行环境有权访问的所有变量和函数的有序访问。通过作用域链可以访问到外层环境的变量和函数。

## 什么是 js 预解析

js 引擎在运行一段代码的时候，会按照下面的步骤进行：

- 把变量的声明提升到当前作用域的最前面，只会提升声明，不会提升赋值。
- 把函数的申明提升到当前作用域的最前面，只会提升声明，不会提升调用
- 优先提升 function，再提升 var

## 浏览器的垃圾回收机制

**回收机制**

- avascript 具有自动垃圾回收机制，会定期对那些不再使用的变量、对象所占用的内存进行释放，原理就是找到不再使用的变量，然后释放掉其占用的内存。
- JavaScript 中存在两种变量：局部变量和全局变量。全局变量的生命周期会持续要页面卸载；而局部变量声明在函数中，它的生命周期从函数执行开始，直到函数执行结束，在这个过程中，局部变量会在堆或栈中存储它们的值，当函数执行结束后，这些局部变量不再被使用，它们所占有的空间就会被释放。
- 不过，当局部变量被外部函数使用时，其中一种情况就是闭包，在函数执行结束后，函数外部的变量依然指向函数内部的局部变量，此时局部变量依然在被使用，所以不会回收。

**如何减少垃圾回收**

- 对数组进行优化：清空数组时，将其长度设置为 0 而不是重新赋值[]
- 对对象进行优化：不用的对象设置为 null

**内存泄漏**

由于疏忽或者错误造成程序未能释放已经不再需要的内存。

**内存泄漏的案例**

- 意外的全局变量
- 被遗忘的计时器或者回调
- 脱离 DOM 的引用
- 闭包
