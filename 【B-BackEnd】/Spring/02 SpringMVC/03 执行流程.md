---

# ğŸ§± SpringMVC ä¸‰å±‚æ¶æ„è¯¦è§£ï¼šControllerã€Serviceã€DAO

---

# SpringMVC ä¸‰å±‚ç»“æ„

## ä¼˜ç‚¹

| ç‰¹æ€§          | è¯´æ˜                         |
| ----------- | -------------------------- |
| **èŒè´£åˆ†æ˜**    | å„å¸å…¶èŒï¼Œæ˜“äºç»´æŠ¤                  |
| **æ˜“äºæµ‹è¯•**    | å¯åˆ†åˆ«æµ‹è¯• Controller / Service |
| **æ”¯æŒæ‰©å±•å’Œå¤ç”¨** | Service å¯å¤ç”¨ï¼ŒDAO å¯æ¨¡å—åŒ–       |
| **è§£è€¦çµæ´»**    | ä»»æ„å±‚æ”¹åŠ¨å¯¹å…¶ä»–å±‚å½±å“è¾ƒå°              |

## æ‰§è¡Œæµç¨‹

```
å‰ç«¯è¯·æ±‚
   â†“
@Controllerï¼ˆè¡¨ç°å±‚ï¼‰  ğŸ‘‰ å¤„ç†è¯·æ±‚å’Œå“åº”ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘
   â†“
@Serviceï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰ ğŸ‘‰ å°è£…ä¸šåŠ¡è§„åˆ™ï¼Œäº‹åŠ¡å¤„ç†ï¼Œè°ƒç”¨ DAO
   â†“
@DAO / @Mapperï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰ ğŸ‘‰ æ“ä½œæ•°æ®åº“
```

## å±‚çº§è¯¦è§£

### 1. Controller å±‚ï¼ˆè¡¨ç°å±‚ï¼‰

**ä½œç”¨**

- æ¥æ”¶å‰ç«¯è¯·æ±‚
- æå–å‚æ•°ã€è°ƒç”¨ Service
- è¿”å› JSON å“åº”ï¼ˆæˆ–é¡µé¢ï¼‰

**ç¤ºä¾‹**

```java
@RestController
@RequestMapping("/users")
public class UserController {

  @Autowired
  private UserService userService;

  // GET /users/1
  @GetMapping("/{id}")
  public User getUser(@PathVariable Long id) {
    return userService.getUserById(id);
  }

  // POST /users + JSON
  @PostMapping
  public User createUser(@RequestBody User user) {
    return userService.createUser(user);
  }
}
```

### 2. Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰

**ä½œç”¨**

- å®ç°å…·ä½“çš„ä¸šåŠ¡æ“ä½œï¼ˆå¦‚æ ¡éªŒã€ç»„åˆé€»è¾‘ã€äº‹åŠ¡ï¼‰
- å°è£…å¯¹ DAO çš„è°ƒç”¨
- å¯¹å¤–æä¾›ç»Ÿä¸€çš„ä¸šåŠ¡æ¥å£

**ç¤ºä¾‹**

```java
@Service
public class UserService {

  @Autowired
  private UserMapper userMapper;

  public User getUserById(Long id) {
    return userMapper.selectById(id);
  }

  public User createUser(User user) {
    // ä¸šåŠ¡è§„åˆ™æ ¡éªŒã€é»˜è®¤å€¼è®¾ç½®ç­‰
    user.setCreateTime(LocalDateTime.now());
    userMapper.insert(user);
    return user;
  }
}
```

### 3. DAO å±‚ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰

**ä½œç”¨**

- å°è£…æ‰€æœ‰æ•°æ®åº“äº¤äº’é€»è¾‘
- é€šå¸¸ä¸ MyBatis/JPA é…åˆ
- åªè´Ÿè´£æ•°æ®çš„å¢åˆ æ”¹æŸ¥

**ç¤ºä¾‹**

```java
@Mapper
public interface UserMapper {
  User selectById(Long id);
  int insert(User user);
}
```

```xml
<select id="selectById" resultType="User">
  SELECT * FROM users WHERE id = #{id}
</select>
```

# SpringMVC æ‹¦æˆªå™¨

SpringMVC æ‹¦æˆªå™¨ï¼ˆ**Interceptor**ï¼‰æ˜¯å®ç°è¯·æ±‚é¢„å¤„ç†å’Œåå¤„ç†çš„é‡è¦æœºåˆ¶ï¼Œç±»ä¼¼äº Servlet çš„ Filterï¼Œä½†æ›´è´´è¿‘ SpringMVC çš„å¤„ç†æµç¨‹ã€‚å®ƒå¸¸ç”¨äºæƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ã€ç»Ÿä¸€å¤„ç†è¯·æ±‚å¤´/å“åº”å¤´ç­‰ã€‚

## 1. æ‹¦æˆªå™¨çš„ä½œç”¨

- **è¯·æ±‚åˆ°è¾¾ Controller ä¹‹å‰** æ‰§è¡Œï¼ˆå¦‚ç™»å½•æ ¡éªŒã€æƒé™éªŒè¯ï¼‰
- **Controller æ‰§è¡Œä¹‹åï¼Œè§†å›¾æ¸²æŸ“ä¹‹å‰** æ‰§è¡Œï¼ˆå¦‚ç»Ÿä¸€ Model å¤„ç†ï¼‰
- **æ•´ä¸ªè¯·æ±‚å®Œæˆåï¼ˆåŒ…æ‹¬è§†å›¾æ¸²æŸ“åï¼‰** æ‰§è¡Œï¼ˆå¦‚æ—¥å¿—ã€èµ„æºé‡Šæ”¾ï¼‰

## 2. åŸºæœ¬ç»“æ„ä¸æ–¹æ³•

**æ ¸å¿ƒæ¥å£ï¼š`HandlerInterceptor`**

```java
public interface HandlerInterceptor {
  boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception;

  void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception;

  void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception;
}
```

|æ–¹æ³•å|æ‰§è¡Œæ—¶æœº|è¿”å›å€¼/æ„ä¹‰|
|---|---|---|
|`preHandle()`|Controller æ–¹æ³•è°ƒç”¨å‰|`false` è¡¨ç¤ºä¸­æ–­åç»­æµç¨‹|
|`postHandle()`|Controller è¿”å›åï¼Œè§†å›¾æ¸²æŸ“å‰|å¯ä¿®æ”¹è¿”å›æ•°æ®ï¼ˆä»…é™é¡µé¢ï¼‰|
|`afterCompletion()`|æ•´ä¸ªè¯·æ±‚å®Œæˆåï¼ˆåŒ…æ‹¬æ¸²æŸ“ï¼‰|å¯ç”¨äºæ—¥å¿—ã€å¼‚å¸¸å¤„ç†ã€èµ„æºé‡Šæ”¾|

## 3. å®šä¹‰æ‹¦æˆªå™¨

```java
public class LoginInterceptor implements HandlerInterceptor {

  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    Object user = request.getSession().getAttribute("loginUser");
    if (user == null) {
      response.sendRedirect("/login");
      return false; // æ‹¦æˆªè¯·æ±‚
    }
    return true;
  }

  @Override
  public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
    System.out.println("è¯·æ±‚ç»“æŸï¼š" + request.getRequestURI());
  }
}
```

## 4. æ³¨å†Œæ‹¦æˆªå™¨

Spring Boot æˆ– SpringMVC ä¸­é€šè¿‡é…ç½®ç±»å®ç°ï¼š

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

  @Override
  public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(new LoginInterceptor())
      .addPathPatterns("/**")         // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
      .excludePathPatterns("/login", "/css/**", "/js/**"); // æ”¾è¡Œç™»å½•é¡µå’Œé™æ€èµ„æº
  }
}
```

## 5. æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

|å®è·µå»ºè®®|è¯´æ˜|
|---|---|
|é¿å…ä¸šåŠ¡é€»è¾‘è¿‡é‡|æ‹¦æˆªå™¨ç”¨äºâ€œè¿‡æ»¤å™¨â€é€»è¾‘ï¼Œä¸åº”åšå¤ªå¤æ‚çš„ä¸šåŠ¡å¤„ç†|
|ä¸ `@ControllerAdvice` åŒºåˆ†ä½¿ç”¨|å¼‚å¸¸å¤„ç†ã€å…¨å±€æ•°æ®ç»‘å®šæ›´é€‚åˆç”¨ `ControllerAdvice`|
|æ³¨æ„æ€§èƒ½|`preHandle()` æ˜¯æ‰€æœ‰è¯·æ±‚çš„å…¥å£ï¼Œåº”ä¼˜åŒ–åˆ¤æ–­é€»è¾‘|
|å¯é“¾å¼æ‰§è¡Œå¤šä¸ªæ‹¦æˆªå™¨|æ‹¦æˆªå™¨æŒ‰æ³¨å†Œé¡ºåºæ‰§è¡Œï¼Œç±»ä¼¼è¿‡æ»¤å™¨é“¾|

## 6. ä¸ Filter åŒºåˆ«

|ç‰¹æ€§|Filter|Interceptorï¼ˆSpringMVCï¼‰|
|---|---|---|
|ç”Ÿå‘½å‘¨æœŸ|Servlet å®¹å™¨å±‚é¢|SpringMVC å±‚é¢ï¼ˆæ§åˆ¶å™¨ä¹‹å‰ï¼‰|
|æŠ€æœ¯æ¥å£|`javax.servlet.Filter`|`HandlerInterceptor`|
|æ‹¦æˆªèŒƒå›´|æ‰€æœ‰è¯·æ±‚|DispatcherServlet å¤„ç†çš„è¯·æ±‚|
|å¯è®¿é—®æ•°æ®|æ—  Spring ä¸Šä¸‹æ–‡|å¯ä½¿ç”¨ Spring Bean|

---

# SpringMVC æ‹¦æˆªå™¨ - æ¡ˆä¾‹

## 1. å®šä¹‰ç™»å½•æ‹¦æˆªå™¨

```java
package com.example.demo.interceptor;

import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.web.servlet.HandlerInterceptor;

import java.util.HashMap;
import java.util.Map;

public class LoginInterceptor implements HandlerInterceptor {

  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    Object user = request.getSession().getAttribute("loginUser");
    if (user == null) {
      // è¿”å› JSON è€Œä¸æ˜¯é‡å®šå‘
      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED); // 401
      response.setContentType("application/json;charset=UTF-8");
      Map<String, Object> resp = new HashMap<>();
      resp.put("code", 401);
      resp.put("message", "æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");

      String json = new ObjectMapper().writeValueAsString(resp);
      response.getWriter().write(json);
      return false;
    }
    return true;
  }
}
```

## 2. æ³¨å†Œç™»å½•æ‹¦æˆªå™¨

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

  @Override
  public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(new LogInterceptor())
            .addPathPatterns("/**")
            .excludePathPatterns("/login", "/doLogin", "/logout", "/static/**");
  }
}
```

## 3. æ³¨å†Œæ§åˆ¶å™¨

```java
@RestController
@RequestMapping("/api")
public class UserController {

  @PostMapping("/doLogin")
  public Map<String, Object> login(@RequestParam String username, HttpSession session) {
    session.setAttribute("loginUser", username);
    return Map.of("code", 200, "message", "ç™»å½•æˆåŠŸ");
  }

  @PostMapping("/logout")
  public Map<String, Object> logout(HttpSession session) {
    session.invalidate();
    return Map.of("code", 200, "message", "é€€å‡ºç™»å½•");
  }

  @GetMapping("/users")
  public Map<String, Object> getUserList() {
    return Map.of("code", 200, "data", List.of("å¼ ä¸‰", "æå››", "ç‹äº”"));
  }
}
```

---

# SpringMVC å¼‚å¸¸å¤„ç†

> åœ¨ SpringMVC ä¸­ï¼Œå¤„ç†å…¨å±€å¼‚å¸¸æœ€å¸¸ç”¨çš„å°±æ˜¯ `@ControllerAdvice` å’Œ `@ExceptionHandler`ã€‚è¿™ä¸¤ä¸ªæ³¨è§£é…åˆä½¿ç”¨ï¼Œå¯ä»¥éå¸¸ä¼˜é›…åœ°ç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¸­çš„å¼‚å¸¸ï¼Œé¿å…æ¯ä¸ªæ§åˆ¶å™¨éƒ½å†™é‡å¤çš„ try-catch ä»£ç ã€‚

## å¼‚å¸¸å¤„ç†çš„ä½œç”¨

- ä¿è¯æ¥å£å¼‚å¸¸ç»Ÿä¸€è¿”å› JSONï¼Œä¸å‡ºç°é¡µé¢æŠ¥é”™ã€‚
- è®©å‰ç«¯æ¥æ”¶ä¸€è‡´ç»“æ„çš„é”™è¯¯å“åº”ã€‚
- é›†ä¸­ç®¡ç†å¼‚å¸¸ï¼Œå¢å¼ºå¯ç»´æŠ¤æ€§å’Œæ—¥å¿—è®°å½•ã€‚

## `@ControllerAdvice` æ³¨è§£

`@ControllerAdvice` æ˜¯ä¸€ä¸ª**å…¨å±€æ§åˆ¶å™¨å¢å¼ºå™¨**ï¼Œå®ƒæ˜¯ `@Component` çš„å˜ä½“ï¼Œä¼šè¢« Spring è‡ªåŠ¨æ‰«æå’Œæ³¨å†Œï¼Œå®ƒå¯ä»¥ï¼š

- æ‹¦æˆªæ‰€æœ‰ä½¿ç”¨ `@Controller` å’Œ `@RestController` æ³¨è§£çš„ç±»ã€‚
- ç»Ÿä¸€å¤„ç†å¼‚å¸¸ã€ç»‘å®šæ•°æ®ã€æ·»åŠ å…¨å±€æ¨¡å‹å±æ€§ç­‰ã€‚

## `@ExceptionHandler` æ³¨è§£

`@ExceptionHandler` ç”¨æ¥å®šä¹‰æŸç§ç±»å‹å¼‚å¸¸çš„å¤„ç†æ–¹æ³•ã€‚å®ƒå¯ä»¥å•ç‹¬å†™åœ¨æŸä¸ªæ§åˆ¶å™¨ä¸­ï¼Œä¹Ÿå¯ä»¥ç»“åˆ `@ControllerAdvice` å†™æˆå…¨å±€å¼‚å¸¸å¤„ç†å™¨ã€‚

## `@RestControllerAdvice` æ³¨è§£

`@RestControllerAdvice = @ControllerAdvice + @ResponseBody`ï¼Œç”¨æ¥è¿”å› json æ ¼å¼çš„é”™è¯¯ä¿¡æ¯ã€‚

```java
@RestControllerAdvice
public class GlobalRestExceptionHandler {

  @ExceptionHandler(Exception.class)
  public Map<String, Object> handle(Exception e) {
    return Map.of(
      "code", 500,
      "message", e.getMessage()
    );
  }
}
```

## åŸºç¡€ç¤ºä¾‹

```java
@ControllerAdvice
public class GlobalExceptionHandler {

  @ExceptionHandler(NullPointerException.class)
  public ResponseEntity<?> handleNullPointer(NullPointerException e) {
    return ResponseEntity.status(500).body(Map.of(
      "code", 500,
      "message", "ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼š" + e.getMessage()
    ));
  }

  @ExceptionHandler(IllegalArgumentException.class)
  public ResponseEntity<?> handleIllegalArg(IllegalArgumentException e) {
    return ResponseEntity.badRequest().body(Map.of(
      "code", 400,
      "message", "å‚æ•°é”™è¯¯ï¼š" + e.getMessage()
    ));
  }
}
```

## å…œåº•å¤„ç†

```java
@ExceptionHandler(Exception.class)
public ResponseEntity<?> handleAll(Exception e) {
  return ResponseEntity.status(500).body(Map.of(
    "code", 500,
    "message", "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼š" + e.getMessage()
  ));
}
```

# SpringMVC å¼‚å¸¸å¤„ç† - æœ€ä½³å®è·µ

## 1. å®šä¹‰é”™è¯¯æšä¸¾

```java
package com.example.common;

/**
 * ç³»ç»Ÿç»Ÿä¸€é”™è¯¯ç å®šä¹‰
 */
public enum ErrorCode {
  SUCCESS(200, "æ“ä½œæˆåŠŸ"),
  PARAM_ERROR(400, "å‚æ•°é”™è¯¯"),
  UNAUTHORIZED(401, "æœªè®¤è¯"),
  FORBIDDEN(403, "æ— æƒé™è®¿é—®"),
  NOT_FOUND(404, "èµ„æºä¸å­˜åœ¨"),
  SERVER_ERROR(500, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"),
  BIZ_ERROR(600, "ä¸šåŠ¡é€»è¾‘é”™è¯¯");
  
  USER_NOT_FOUND(10001, "ç”¨æˆ·ä¸å­˜åœ¨"),
  USERNAME_EXISTS(10002, "ç”¨æˆ·åå·²è¢«å ç”¨"),
  LOGIN_FAILED(10003, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"),


  private final int code;
  private final String message;

  ErrorCode(int code, String message) {
    this.code = code;
    this.message = message;
  }

  public int getCode() {
    return code;
  }

  public String getMessage() {
    return message;
  }
}

```

## 2. ç»Ÿä¸€å“åº”ç»“æœç±» ResponseResult

```java
package com.example.common;

import lombok.Data;

/**
 * é€šç”¨å“åº”ç»“æœå°è£…ç±»
 * é€‚ç”¨äºå‰åç«¯åˆ†ç¦»æ¶æ„ä¸­ç»Ÿä¸€è¿”å›æ ¼å¼
 */
@Data
public class ResponseResult<T> {

  /** çŠ¶æ€ç  */
  private int code;

  /** æç¤ºä¿¡æ¯ */
  private String message;

  /** è¿”å›æ•°æ® */
  private T data;

  /**
   * è¯·æ±‚æˆåŠŸï¼Œå¸¦æ•°æ®
   * @param data è¿”å›çš„æ•°æ®
   * @return ResponseResult åŒ…è£…æˆåŠŸæ•°æ®
   */
  public static <T> ResponseResult<T> success(T data) {
    return of(ErrorCode.SUCCESS, data);
  }

  /**
   * è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨é¢„å®šä¹‰çš„é”™è¯¯ç 
   * @param errorCode é”™è¯¯ç æšä¸¾
   * @return ResponseResult å¤±è´¥å“åº”
   */
  public static <T> ResponseResult<T> fail(ErrorCode errorCode) {
    return of(errorCode, null);
  }

  /**
   * è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨é¢„å®šä¹‰é”™è¯¯ç ï¼Œä½†è‡ªå®šä¹‰æ¶ˆæ¯
   * @param errorCode é”™è¯¯ç æšä¸¾
   * @param customMessage è‡ªå®šä¹‰é”™è¯¯æç¤º
   * @return ResponseResult å¤±è´¥å“åº”
   */
  public static <T> ResponseResult<T> fail(ErrorCode errorCode, String customMessage) {
    return of(errorCode.getCode(), customMessage, null);
  }

  /**
   * ä½¿ç”¨ ErrorCode æ„é€ è¿”å›ç»“æœ
   * @param errorCode é”™è¯¯ç æšä¸¾
   * @param data è¿”å›çš„æ•°æ®
   * @return ResponseResult å“åº”ç»“æ„
   */
  public static <T> ResponseResult<T> of(ErrorCode errorCode, T data) {
    return of(errorCode.getCode(), errorCode.getMessage(), data);
  }

  /**
   * é€šç”¨æ„é€ æ–¹æ³•ï¼ˆæœ€åº•å±‚ï¼‰
   * @param code çŠ¶æ€ç 
   * @param message æç¤ºä¿¡æ¯
   * @param data è¿”å›æ•°æ®
   * @return ResponseResult å¯¹è±¡
   */
  public static <T> ResponseResult<T> of(int code, String message, T data) {
    ResponseResult<T> r = new ResponseResult<>();
    r.code = code;
    r.message = message;
    r.data = data;
    return r;
  }
}

```

## 3. å®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±» BizException

```java
package com.example.exception;

import com.example.common.ErrorCode;

public class BizException extends RuntimeException {
  private final int code;

  public BizException(ErrorCode errorCode) {
    super(errorCode.getMessage());
    this.code = errorCode.getCode();
  }

  public BizException(ErrorCode errorCode, String customMessage) {
    super(customMessage);
    this.code = errorCode.getCode();
  }

  public int getCode() {
    return code;
  }
}

```

## 4. å…¨å±€å¼‚å¸¸å¤„ç†å™¨ GlobalExceptionHandler

```java
@ExceptionHandler(BizException.class)
public ResponseResult<?> handleBizException(BizException e) {
  return ResponseResult.of(e.getCode(), e.getMessage(), null);
}

```

## 5. ä½¿ç”¨ç¤ºä¾‹

```java
@RestController
@RequestMapping("/user")
public class UserController {

  @GetMapping("/{id}")
  public ResponseResult<?> getUser(@PathVariable int id) {
    if (id < 1) {
      throw new BizException("ç”¨æˆ· ID ä¸åˆæ³•");
    }
    return ResponseResult.success("ç”¨æˆ·ä¿¡æ¯ï¼š" + id);
  }
}
```

---

# SpringMVC æ•°æ®æ ¡éªŒ

> **SpringMVC ä¸­çš„æ•°æ®æ ¡éªŒæœºåˆ¶**ï¼Œæ˜¯åœ¨å¼€å‘ REST API æ—¶ä¿éšœå‚æ•°åˆæ³•æ€§çš„é‡è¦æ‰‹æ®µï¼Œç‰¹åˆ«é€‚ç”¨äºå‰åç«¯åˆ†ç¦»é¡¹ç›®ã€‚

## æ ¡éªŒæ¡†æ¶

SpringMVC é€šå¸¸æ•´åˆ **JSR 303/380 Bean Validation**ï¼ˆHibernate Validator ä¸ºé»˜è®¤å®ç°ï¼‰ï¼Œä¸»è¦é€šè¿‡æ³¨è§£æ–¹å¼è¿›è¡Œå­—æ®µéªŒè¯ã€‚

## å®ç°æ­¥éª¤

### 1. å¼•å…¥ä¾èµ–

Spring Boot ä¸­é»˜è®¤åŒ…å«ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ ã€‚

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

### 2. å®ä½“ç±»æ·»åŠ æ ¡éªŒæ³¨è§£

```java
package com.example.dto;

import jakarta.validation.constraints.*;

public class UserAddDTO {

  @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
  private String username;

  @Size(min = 6, message = "å¯†ç é•¿åº¦ä¸èƒ½å°äº6ä½")
  private String password;

  @Min(value = 18, message = "å¹´é¾„ä¸èƒ½å°äº18å²")
  private Integer age;

  @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
  private String email;

  // getter / setter
}
```

### 3. åœ¨ Controller ä¸­å¯ç”¨æ ¡éªŒ

```java
import jakarta.validation.Valid;

@RestController
@RequestMapping("/users")
public class UserController {

  @PostMapping
  public ResponseResult<?> addUser(@Valid @RequestBody UserAddDTO dto) {
    // å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œä¼šæŠ›å‡º MethodArgumentNotValidExceptionï¼Œè¢«å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·
    return ResponseResult.success("ç”¨æˆ·æ·»åŠ æˆåŠŸ");
  }
}
```

## å¸¸è§æ³¨è§£åˆ—è¡¨

| æ³¨è§£                        | è¯´æ˜            |
| ------------------------- | ------------- |
| `@NotNull`                | å¯¹è±¡å±æ€§ä¸èƒ½ä¸ºç©º      |
| `@NotBlank`               | å­—ç¬¦ä¸²ä¸èƒ½ä¸ºç©ºï¼ˆå»ç©ºæ ¼åï¼‰ |
| `@Size(min, max)`         | é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦       |
| `@Min/@Max`               | æ•°å­—æœ€å°æœ€å¤§å€¼       |
| `@Email`                  | é‚®ç®±æ ¼å¼          |
| `@Pattern(regexp)`        | æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ       |
| `@Positive` / `@Negative` | æ­£æ•° / è´Ÿæ•°       |
| `@Future` / `@Past`       | æ—¶é—´æ ¡éªŒ          |

## å¼‚å¸¸ç±»å’Œè§¦å‘åœºæ™¯

|å¼‚å¸¸ç±»|è§¦å‘æ¡ä»¶|ä½¿ç”¨æ³¨è§£|
|---|---|---|
| `MethodArgumentNotValidException` | `@RequestBody + @Valid` |DTO|
| `BindException` | `@ModelAttribute + @Validated` |è¡¨å•æˆ–è·¯å¾„å‚æ•°|
| `ConstraintViolationException` | `@RequestParam` / `@PathVariable` + `@Validated` |å•ä¸ªå‚æ•°|

---

# SpringMVC æ•°æ®æ ¡éªŒ - å…¨å±€å¼‚å¸¸å¤„ç†

## å…¨å±€å¤„ç†åŸç†

å½“è¯·æ±‚ä¸­å‚æ•°æ ¡éªŒå¤±è´¥æ—¶ï¼ŒSpring ä¼šæŠ›å‡º `MethodArgumentNotValidException`ï¼ˆç”¨äº JSON è¯·æ±‚ä½“ï¼‰æˆ– `ConstraintViolationException`ï¼ˆç”¨äº URL/è¡¨å•å‚æ•°ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿä¸€æ•è·å¹¶æ ¼å¼åŒ–æç¤ºã€‚

## å®ç°æ­¥éª¤

### 1. å®ä½“ç±»æ·»åŠ æ³¨è§£

```java
public class UserDTO {

  @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
  private String username;

  @Size(min = 6, message = "å¯†ç é•¿åº¦ä¸èƒ½å°äº6ä½")
  private String password;

  // getter / setter
}
```

### 2. å¯ç”¨æ ¡éªŒ

```java
@PostMapping("/register")
public ResponseResult<?> register(@RequestBody @Valid UserDTO userDTO) {
  // å¦‚æœå‚æ•°æ ¡éªŒå¤±è´¥ï¼Œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
  return ResponseResult.success("æ³¨å†ŒæˆåŠŸ");
}
```

### 3. æ³¨å†Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨

```java
package com.example.exception;

import com.example.common.ErrorCode;
import com.example.common.ResponseResult;
import jakarta.validation.ConstraintViolationException;
import org.springframework.validation.BindException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.stream.Collectors;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

  /**
   * å¤„ç† @RequestBody + @Valid æ ¡éªŒå¤±è´¥
   */
  @ExceptionHandler(MethodArgumentNotValidException.class)
  public ResponseResult<?> handleMethodArgumentNotValid(MethodArgumentNotValidException ex) {
    String errorMsg = ex.getBindingResult().getFieldErrors().stream()
        .map(err -> err.getField() + ": " + err.getDefaultMessage())
        .collect(Collectors.joining("; "));
    return ResponseResult.fail(ErrorCode.PARAM_ERROR, errorMsg);
  }

  /**
   * å¤„ç† URL å‚æ•°æˆ–è¡¨å•æäº¤æ ¡éªŒå¤±è´¥ï¼ˆ@ModelAttributeï¼‰
   */
  @ExceptionHandler(BindException.class)
  public ResponseResult<?> handleBindException(BindException ex) {
    String errorMsg = ex.getBindingResult().getFieldErrors().stream()
        .map(FieldError::getDefaultMessage)
        .collect(Collectors.joining("; "));
    return ResponseResult.fail(ErrorCode.PARAM_ERROR, errorMsg);
  }

  /**
   * å¤„ç†å•ä¸ªå‚æ•°æ ¡éªŒå¤±è´¥ï¼Œå¦‚ @RequestParam æ ¡éªŒ
   */
  @ExceptionHandler(ConstraintViolationException.class)
  public ResponseResult<?> handleConstraintViolation(ConstraintViolationException ex) {
    String errorMsg = ex.getConstraintViolations().stream()
        .map(cv -> cv.getPropertyPath() + ": " + cv.getMessage())
        .collect(Collectors.joining("; "));
    return ResponseResult.fail(ErrorCode.PARAM_ERROR, errorMsg);
  }

  /**
   * å…¶ä»–å¼‚å¸¸ç»Ÿä¸€å¤„ç†
   */
  @ExceptionHandler(Exception.class)
  public ResponseResult<?> handleOtherExceptions(Exception ex) {
    // ç”Ÿäº§ç¯å¢ƒä¸­åº”è®°å½•å¼‚å¸¸æ—¥å¿—
    return ResponseResult.fail(ErrorCode.SERVER_ERROR, "æœåŠ¡å™¨å¼‚å¸¸ï¼š" + ex.getMessage());
  }
}
```

---

# SpringMVC æ•°æ®æ ¡éªŒ - è‡ªå®šä¹‰æ ¡éªŒ

## 1. åˆ›å»ºæ³¨è§£ç±»

```java
package com.example.validator;

import jakarta.validation.Constraint;
import jakarta.validation.Payload;

import java.lang.annotation.*;

@Documented
@Constraint(validatedBy = PhoneValidator.class) // æŒ‡å®šæ ¡éªŒå™¨
@Target({ ElementType.FIELD, ElementType.PARAMETER })
@Retention(RetentionPolicy.RUNTIME)
public @interface Phone {

  String message() default "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®";

  Class<?>[] groups() default {};

  Class<? extends Payload>[] payload() default {};
}
```

## 2. åˆ›å»ºæ ¡éªŒå™¨ç±» `PhoneValidator`

```java
package com.example.validator;

import jakarta.validation.ConstraintValidator;
import jakarta.validation.ConstraintValidatorContext;

public class PhoneValidator implements ConstraintValidator<Phone, String> {

  private static final String PHONE_REGEX = "^1[3-9]\\d{9}$"; // ä¸­å›½æ‰‹æœºå·è§„åˆ™

  @Override
  public void initialize(Phone constraintAnnotation) {
    // å¯è¯»å–æ³¨è§£å‚æ•°ï¼Œå¦‚ messageã€æ­£åˆ™ç­‰
  }

  @Override
  public boolean isValid(String value, ConstraintValidatorContext context) {
    if (value == null) return false;
    return value.matches(PHONE_REGEX);
  }
}
```

## 3. ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£

```java
public class RegisterDTO {

  @Phone(message = "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·")
  private String phone;

  @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
  private String password;

  // getter / setter
}
```

## 4. æ§åˆ¶å™¨ä¸­å¯ç”¨æ ¡éªŒ

```java
@PostMapping("/register")
public ResponseResult<?> register(@RequestBody @Valid RegisterDTO dto) {
  return ResponseResult.success();
}
```

---

# SpringMVC æ¨¡å‹åˆ†å±‚ - VO

## VO æ¦‚å¿µ

**VOï¼ˆView Objectï¼‰**ï¼šç”¨äºâ€œå°è£…æ¥å£è¾“å‡ºç»“æœâ€çš„ç±»ï¼ŒåªåŒ…å«å‰ç«¯çœŸæ­£éœ€è¦å±•ç¤ºçš„å­—æ®µï¼Œä¸åŒ…å«æ•æ„Ÿå­—æ®µã€ä¸ç›´æ¥æš´éœ²å†…éƒ¨ç»“æ„ã€‚

## å¸¸è§æ¨¡å‹åˆ†å±‚

| å±‚çº§         | ä½œç”¨                           | ç¤ºä¾‹                           |
| ---------- | ---------------------------- | ---------------------------- |
| **Entity** | å®ä½“ç±»ï¼Œæ˜ å°„æ•°æ®åº“è¡¨                   | `UserEntity`                 |
| **DTO**    | Data Transfer Objectï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‚æ•° | `UserAddDTO`ã€`UserUpdateDTO` |
| **VO**     | View Objectï¼Œå¯¹å¤–è¿”å›å±•ç¤ºç”¨æ•°æ®        | `UserVO`                     |
| **BO**ï¼ˆå¯é€‰ï¼‰ | Business Objectï¼Œä¸šåŠ¡ä¸­é—´å°è£…æ¨¡å‹     | `UserBO`                     |

## è½¬æ¢

**æ‰‹åŠ¨è½¬æ¢**

```java
public class UserConverter {
  public static UserVO toVO(UserEntity entity) {
    UserVO vo = new UserVO();
    vo.setId(entity.getId());
    vo.setUsername(entity.getUsername());
    vo.setEmail(entity.getEmail());
    return vo;
  }
}
```

**ä½¿ç”¨ Spring çš„ `BeanUtils` è½¬æ¢**

```java
UserVO vo = new UserVO();
BeanUtils.copyProperties(entity, vo);
```

## VO ä¼˜ç‚¹

- ä¸ä¼šæš´éœ²æ•æ„Ÿå­—æ®µï¼ˆå¦‚å¯†ç ã€Tokenï¼‰
- ä¸ä¼šæš´éœ²æ•°æ®åº“ç»“æ„ï¼ˆå­—æ®µåã€å¤–é”®ç­‰ï¼‰

## ç¤ºä¾‹

### 1. Entityï¼ˆæ•°æ®åº“å®ä½“ç±»ï¼‰

```java
public class UserEntity {
  private Long id;
  private String username;
  private String password; // æ•æ„Ÿå­—æ®µ
  private String email;
  private Date createTime;
}
```

### 2. VOï¼ˆåªè¿”å›éœ€è¦çš„æ•°æ®ï¼‰

```java
public class UserVO {
  private Long id;
  private String username;
  private String email;
}
```

---

# SpringMVC æ¥å£æ–‡æ¡£

> åœ¨ SpringMVC æˆ– Spring Boot é¡¹ç›®ä¸­ä½¿ç”¨ **Swagger** å¯ä»¥å¿«é€Ÿä¸ºä½ çš„ API è‡ªåŠ¨ç”Ÿæˆåœ¨çº¿æ¥å£æ–‡æ¡£ã€‚

## ä½œç”¨

- è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
- æä¾›å¯è§†åŒ–ç•Œé¢æµ‹è¯•æ¥å£
- æ”¯æŒå‚æ•°æ ¡éªŒå±•ç¤ºã€è¯·æ±‚å“åº”ç»“æ„é¢„è§ˆ
- å‰åç«¯åä½œæ›´é«˜æ•ˆ

## é›†æˆæ­¥éª¤

### 1. æ·»åŠ ä¾èµ–

```xml
<dependency>
  <groupId>org.springdoc</groupId>
  <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
  <version>2.2.0</version> <!-- å»ºè®®ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ -->
</dependency>
```

### 2. å¯åŠ¨é¡¹ç›®åè®¿é—®åœ°å€

```
http://localhost:8080/swagger-ui/index.html
```

### 3. é…ç½®åŸºç¡€ä¿¡æ¯

å¯æ–°å»ºä¸€ä¸ªé…ç½®ç±»ï¼Œç”¨äºè®¾ç½®é¡¹ç›®æè¿°ã€æ ‡é¢˜ç­‰ï¼š

```java
package com.example.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import org.springdoc.core.models.GroupedOpenApi;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {

  @Bean
  public OpenAPI customOpenAPI() {
    return new OpenAPI()
        .info(new Info()
          .title("ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ API æ–‡æ¡£")
          .version("1.0")
          .description("è¿™æ˜¯ä¸€ä¸ª SpringBoot + SpringMVC ç¤ºä¾‹å·¥ç¨‹"));
  }

  @Bean
  public GroupedOpenApi publicApi() {
    return GroupedOpenApi.builder()
        .group("ç”¨æˆ·æ¥å£")
        .pathsToMatch("/users/**")
        .build();
  }
}
```

## å¸¸ç”¨æ³¨è§£

|æ³¨è§£|è¯´æ˜|
|---|---|
|`@Operation`|æè¿°å•ä¸ªæ¥å£çš„åŠŸèƒ½|
|`@Parameter`|æè¿°å‚æ•°ä¿¡æ¯|
|`@Schema`|ç”¨äºå­—æ®µæˆ–ç±»ä¸Šï¼Œè¯´æ˜å­—æ®µå«ä¹‰ã€ç¤ºä¾‹ç­‰|
|`@Tag`|æè¿° Controller åˆ†ç±»|
|`@RequestBody` / `@ResponseBody`|è‡ªåŠ¨è¯†åˆ«å‚æ•°ç±»å‹|

**ç¤ºä¾‹**ï¼šController

```java
@Tag(name = "ç”¨æˆ·æ¥å£", description = "ç”¨æˆ·çš„å¢åˆ æŸ¥æ”¹æ“ä½œ")
@RestController
@RequestMapping("/users")
public class UserController {

  @Operation(summary = "æ ¹æ® ID è·å–ç”¨æˆ·ä¿¡æ¯")
  @GetMapping("/{id}")
  public ResponseResult<UserVO> getById(
      @Parameter(description = "ç”¨æˆ·ID", required = true) @PathVariable Long id) {
    UserEntity user = userService.getById(id);
    return ResponseResult.success(UserConverter.toVO(user));
  }

  @Operation(summary = "åˆ›å»ºç”¨æˆ·")
  @PostMapping
  public ResponseResult<?> add(@RequestBody @Valid UserAddDTO dto) {
    userService.create(dto);
    return ResponseResult.success("æ·»åŠ æˆåŠŸ");
  }
}
```

**ç¤ºä¾‹**ï¼šVO

```java
public class UserVO {

  @Schema(description = "ç”¨æˆ·ID", example = "1001")
  private Long id;

  @Schema(description = "ç”¨æˆ·å", example = "zhangsan")
  private String username;

  @Schema(description = "é‚®ç®±", example = "test@example.com")
  private String email;
}
```

## æ³¨æ„äº‹é¡¹

- SpringMVC é¡¹ç›®éœ€ä½¿ç”¨ `springdoc-openapi-starter-webmvc-ui` ä¾èµ–
- Controller å¿…é¡»æ˜¯ `@RestController` æˆ– `@Controller + @ResponseBody`
- å¦‚æœæ¥å£è¿”å›å¯¹è±¡æœªæ˜ç¡®å£°æ˜æ³›å‹ï¼ŒSwagger å¯èƒ½æ— æ³•æ­£ç¡®è§£æ

---

# SpringMVC `@JsonFormat`

> `@JsonFormat` æ˜¯ Jackson æä¾›çš„æ³¨è§£ï¼Œå¸¸ç”¨äºåœ¨ä½¿ç”¨ SpringMVC æˆ– Spring Boot å¼€å‘æ—¶æ§åˆ¶ **å¯¹è±¡åºåˆ—åŒ–ä¸º JSON** æ—¶å­—æ®µï¼ˆç‰¹åˆ«æ˜¯æ—¥æœŸæ—¶é—´ç±»å‹ï¼‰çš„æ ¼å¼ã€‚
>
> å®ƒæ˜¯ä½œç”¨åœ¨å­—æ®µæˆ– getter æ–¹æ³•ä¸Šçš„ï¼Œç”¨äºæŒ‡å®šåºåˆ—åŒ–ï¼ˆJava å¯¹è±¡ â†’ JSONï¼‰å’Œååºåˆ—åŒ–ï¼ˆJSON â†’ Java å¯¹è±¡ï¼‰æ—¶çš„æ ¼å¼ã€‚

## å¸¸ç”¨åœºæ™¯

- **æ§åˆ¶æ—¶é—´æ ¼å¼**ï¼ˆå¦‚ `yyyy-MM-dd HH:mm:ss`ï¼‰
- **æ§åˆ¶æ—¶åŒº**

## è¯­æ³•

```java
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
private LocalDateTime createTime;
```

| å‚æ•°å        | è¯´æ˜                                                 |
| ---------- | -------------------------------------------------- |
| `pattern`  | æ—¥æœŸæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ `"yyyy-MM-dd"`ã€`"yyyy-MM-dd HH:mm:ss"` |
| `timezone` | æ—¶åŒºï¼Œä¾‹å¦‚ `"GMT+8"` æˆ– `"Asia/Shanghai"`                |
| `shape`    | æŒ‡å®šå­—æ®µæ ¼å¼ç±»å‹ï¼Œå¸¸ç”¨äºæ•°å­—ã€æšä¸¾æ ¼å¼ï¼Œé»˜è®¤ä¸ç”¨ç®¡                          |
| `locale`   | åœ°åŒºè¯­è¨€è®¾ç½®ï¼Œå°‘ç”¨                                          |

## ç¤ºä¾‹

```java
public class UserVO {

  @JsonFormat(pattern = "yyyy-MM-dd", timezone = "GMT+8")
  private LocalDate birthday;

  @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
  private LocalDateTime createTime;

  @JsonFormat(pattern = "yyyy/MM/dd", timezone = "GMT+8")
  private Date expireDate;
}
```

## å…¨å±€è®¾ç½®

å¦‚æœä½ çš„é¡¹ç›®ä¸­æœ‰å¤§é‡å­—æ®µéƒ½éœ€è¦ç»Ÿä¸€æ ¼å¼ï¼Œå¯ä»¥åœ¨ `application.yml` ä¸­ç»Ÿä¸€é…ç½®ï¼š

```yaml
spring:
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
```

## å¸¸è§é—®é¢˜ä¸é™·é˜±

|é—®é¢˜|åŸå› |è§£å†³æ–¹æ³•|
|---|---|---|
|æ—¶é—´å¤šå‡º 8 å°æ—¶|é»˜è®¤æ˜¯ UTC|æŒ‡å®š `timezone = "GMT+8"`|
|æ³¨è§£æ— æ•ˆ|Bean ä¸æ˜¯é€šè¿‡ Spring æ³¨å…¥æˆ–æ˜¯ getter æ–¹æ³•æ²¡æœ‰åŠ æ³¨è§£|æ£€æŸ¥æ³¨è§£ä½ç½®æˆ–ä½¿ç”¨ `@JsonFormat` æ”¾åœ¨ getter ä¸Š|
|å’Œå…¨å±€é…ç½®å†²çª|æ–¹æ³•/å­—æ®µçš„æ³¨è§£ä¼˜å…ˆçº§é«˜äºå…¨å±€é…ç½®|æ˜ç¡®æ¯ä¸ªå­—æ®µæ³¨è§£|
